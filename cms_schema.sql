-- Admin CMS Schema

-- 1. Site Settings (Key-Value Store for Global/Page Content)
CREATE TABLE IF NOT EXISTS public.site_settings (
    key TEXT PRIMARY KEY, -- e.g., 'global', 'hero', 'about', 'contact'
    content JSONB NOT NULL DEFAULT '{}'::jsonb,
    updated_at TIMESTAMPTZ DEFAULT now(),
    updated_by UUID REFERENCES auth.users(id)
);

-- 2. News Items
CREATE TABLE IF NOT EXISTS public.news_items (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    title TEXT NOT NULL,
    source TEXT NOT NULL, -- e.g. "OnlineKhabar"
    date DATE NOT NULL DEFAULT CURRENT_DATE,
    type TEXT NOT NULL CHECK (type IN ('Article', 'Video', 'Interview')),
    link TEXT NOT NULL, -- External URL or Internal Path
    image_url TEXT,
    is_published BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT now(),
    updated_by UUID REFERENCES auth.users(id)
);

-- 3. Media Gallery (Photos & Videos)
CREATE TABLE IF NOT EXISTS public.media_gallery (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    type TEXT NOT NULL CHECK (type IN ('image', 'video')),
    url TEXT NOT NULL, -- YouTube URL or Image URL
    caption TEXT,
    thumbnail_url TEXT, -- For videos or optimized images
    created_at TIMESTAMPTZ DEFAULT now(),
    updated_by UUID REFERENCES auth.users(id)
);

-- 4. User Profiles & Roles
CREATE TABLE IF NOT EXISTS public.profiles (
    id UUID REFERENCES auth.users(id) ON DELETE CASCADE PRIMARY KEY,
    email TEXT,
    role TEXT NOT NULL DEFAULT 'user' CHECK (role IN ('admin', 'user')),
    created_at TIMESTAMPTZ DEFAULT now()
);

-- 5. Enable RLS
ALTER TABLE public.site_settings ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.news_items ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.media_gallery ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;

-- 6. Policies

-- Profiles: Users can read their own profile. Admins can read all.
CREATE POLICY "Public profiles are viewable by everyone." ON public.profiles FOR SELECT USING (true); -- Simplified for now, or strict: auth.uid() = id
CREATE POLICY "Users can insert their own profile." ON public.profiles FOR INSERT WITH CHECK (auth.uid() = id);
CREATE POLICY "Users can update their own profile." ON public.profiles FOR UPDATE USING (auth.uid() = id);

-- CMS Content: Public Read
CREATE POLICY "Public read access" ON public.site_settings FOR SELECT USING (true);
CREATE POLICY "Public read access" ON public.news_items FOR SELECT USING (is_published = true);
CREATE POLICY "Public read access" ON public.media_gallery FOR SELECT USING (true);

-- CMS Content: Admin Write Only
-- We need a helper to check if user is admin. unique to Supabase logic often involves a joined check or claims.
-- For simplicity in SQL policies without custom claims:
-- USING (auth.uid() IN (SELECT id FROM public.profiles WHERE role = 'admin'))

CREATE POLICY "Admin write access settings" ON public.site_settings FOR ALL USING (
    auth.role() = 'authenticated' AND 
    auth.uid() IN (SELECT id FROM public.profiles WHERE role = 'admin')
);

CREATE POLICY "Admin write access news" ON public.news_items FOR ALL USING (
    auth.role() = 'authenticated' AND 
    auth.uid() IN (SELECT id FROM public.profiles WHERE role = 'admin')
);

CREATE POLICY "Admin write access media" ON public.media_gallery FOR ALL USING (
    auth.role() = 'authenticated' AND 
    auth.uid() IN (SELECT id FROM public.profiles WHERE role = 'admin')
);

-- 7. Trigger for New Users
-- Automatically create profile on signup
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.profiles (id, email, role)
  VALUES (new.id, new.email, 'user');
  RETURN new;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE OR REPLACE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE PROCEDURE public.handle_new_user();

-- 8. Seed Data (Migrated content...)
-- ... (Existing seed insertions) ...
-- Seed Admin User (Optional/Manual):
-- INSERT INTO public.profiles (id, email, role) VALUES ('<UUID>', 'admin@pragatishil.org', 'admin');


-- 'global' settings (Nav, Brand, Footer, Contact, Social) - Simplified structure matching SiteSettings interface roughly
INSERT INTO public.site_settings (key, content)
VALUES
('global', '{
    "nav": {
        "home": { "en": "Home", "ne": "‡§ó‡•É‡§π‡§™‡•É‡§∑‡•ç‡§†" },
        "news": { "en": "News", "ne": "‡§∏‡§Æ‡§æ‡§ö‡§æ‡§∞" },
        "media": { "en": "Media", "ne": "‡§Æ‡§ø‡§°‡§ø‡§Ø‡§æ" },
        "about": { "en": "About", "ne": "‡§π‡§æ‡§Æ‡•ç‡§∞‡•ã ‡§¨‡§æ‡§∞‡•á‡§Æ‡§æ" },
        "contact": { "en": "Contact", "ne": "‡§∏‡§Æ‡•ç‡§™‡§∞‡•ç‡§ï" },
        "members": { "en": "Members", "ne": "‡§∏‡§¶‡§∏‡•ç‡§Ø‡§π‡§∞‡•Ç" },
        "join": { "en": "Join Movement", "ne": "‡§Ö‡§≠‡§ø‡§Ø‡§æ‡§®‡§Æ‡§æ ‡§ú‡•ã‡§°‡§ø‡§®‡•Å‡§π‡•ã‡§∏‡•ç" },
        "brand": {
             "firstEn": "Pragatishil", "secondEn": "Loktantrik",
             "firstNe": "‡§™‡•ç‡§∞‡§ó‡§§‡§ø‡§∂‡•Ä‡§≤", "secondNe": "‡§≤‡•ã‡§ï‡§§‡§æ‡§®‡•ç‡§§‡•ç‡§∞‡§ø‡§ï"
        }
    },
    "contact": {
        "address": "Baneshwor, Kathmandu, Nepal",
        "email": "info@pragatishil.org.np",
        "phone": "+977-1-4XXXXXX"
    },
    "social": [
        { "name": "Facebook", "icon": "facebook", "url": "https://facebook.com" },
        { "name": "Twitter", "icon": "twitter", "url": "https://twitter.com" },
        { "name": "YouTube", "icon": "youtube", "url": "https://youtube.com" },
        { "name": "Instagram", "icon": "instagram", "url": "https://instagram.com" },
        { "name": "TikTok", "icon": "tiktok", "url": "https://tiktok.com" }
    ],
    "footer": {
        "taglineNe": "‡§®‡•á‡§™‡§æ‡§≤‡•Ä ‡§Æ‡§æ‡§ü‡•ã, ‡§π‡§æ‡§Æ‡•ç‡§∞‡•ã ‡§¨‡§æ‡§ü‡•ã",
        "taglineEn": "Building a just, progressive and prosperous Nepal from our own soil."
    }
}'::jsonb),

('hero', '{
    "pillNe": "Pragatishil Loktantrik",
    "titleNe": "‡§™‡•ç‡§∞‡§ó‡§§‡§ø‡§∂‡•Ä‡§≤ ‡§≤‡•ã‡§ï‡§§‡§æ‡§®‡•ç‡§§‡•ç‡§∞‡§ø‡§ï ‡§™‡§æ‡§∞‡•ç‡§ü‡•Ä‡§Æ‡§æ ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§õ",
    "titleEn": "Welcome to Pragatishil Loktantrik Party",
    "subtitleNe": "‡§®‡•á‡§™‡§æ‡§≤‡•Ä ‡§Æ‡§æ‡§ü‡•ã, ‡§π‡§æ‡§Æ‡•ç‡§∞‡•ã ‡§¨‡§æ‡§ü‡•ã",
    "subtitleEnLine1": "Progressive socialist, democratic alternative for Nepal.",
    "subtitleEnLine2": "Rooted in Nepali soil, walking our own path with justice, inclusion and good governance.",
    "ctaPrimary": "Join the Movement",
    "ctaSecondary": "View Members"
}'::jsonb),

('vision', '{
    "titleNe": "‡§π‡§æ‡§Æ‡•ç‡§∞‡•ã ‡§¶‡•É‡§∑‡•ç‡§ü‡§ø‡§ï‡•ã‡§£",
    "titleEn": "Our Vision",
    "textNe": "‡§π‡§æ‡§Æ‡•Ä ‡§è‡§ï ‡§∏‡§Æ‡§§‡§æ‡§Æ‡•Ç‡§≤‡§ï ‡§∏‡§Æ‡§æ‡§ú‡§ï‡•ã ‡§™‡§∞‡§ø‡§ï‡§≤‡•ç‡§™‡§®‡§æ ‡§ó‡§∞‡•ç‡§õ‡•å‡§Ç ‡§ú‡§π‡§æ‡§Å ‡§™‡•ç‡§∞‡§§‡•ç‡§Ø‡•á‡§ï ‡§®‡§æ‡§ó‡§∞‡§ø‡§ï‡§≤‡•á ‡§∏‡§Æ‡§æ‡§® ‡§Ö‡§µ‡§∏‡§∞, ‡§®‡•ç‡§Ø‡§æ‡§Ø ‡§∞ ‡§∏‡§Æ‡•ç‡§Æ‡§æ‡§® ‡§™‡§æ‡§â‡§Å‡§õ‡§®‡•ç‡•§",
    "textEn": "We envision an equitable society where every citizen enjoys equal opportunities, justice, and dignity.",
    "pillars": [
        { "titleNe": "‡§™‡•ç‡§∞‡§ó‡§§‡§ø‡§∂‡•Ä‡§≤ ‡§∏‡§Æ‡§æ‡§ú‡§µ‡§æ‡§¶", "titleEn": "Progressive Socialism", "descEn": "Our guiding ideology ‚Äì combining social justice, democracy and modern development.", "icon": "ü§ù" },
        { "titleNe": "‡§≤‡•ã‡§ï‡§§‡§®‡•ç‡§§‡•ç‡§∞‡§ø‡§ï ‡§Æ‡•Ç‡§≤‡•ç‡§Ø‡§π‡§∞‡•Ç", "titleEn": "Democratic Values", "descEn": "Multi-party democracy, civil liberties, rule of law and accountable institutions.", "icon": "üó≥Ô∏è" },
        { "titleNe": "‡§∏‡§Æ‡§æ‡§µ‡•á‡§∂‡•Ä ‡§®‡•á‡§§‡•É‡§§‡•ç‡§µ", "titleEn": "Inclusive Leadership", "descEn": "Youth, women and marginalized communities at every level of party leadership.", "icon": "üë•" },
        { "titleNe": "‡§Ü‡§ß‡•Å‡§®‡§ø‡§ï ‡§è‡§ú‡•á‡§®‡•ç‡§°‡§æ", "titleEn": "Gen Z & Modern Agendas", "descEn": "Addressing the concerns of new generations ‚Äì jobs, innovation, climate, digital rights.", "icon": "üöÄ" },
        { "titleNe": "‡§∏‡§Ç‡§ò‡•Ä‡§Ø‡§§‡§æ ‡§∞ ‡§ú‡§ø‡§Æ‡•ç‡§Æ‡•á‡§µ‡§æ‡§∞ ‡§∞‡§æ‡§∑‡•ç‡§ü‡•ç‡§∞‡§µ‡§æ‡§¶", "titleEn": "Federalism & Nationalism", "descEn": "Strong federalism and national unity, opposing ultra-nationalism and exclusion.", "icon": "üá≥üáµ" },
        { "titleNe": "‡§≠‡•ç‡§∞‡§∑‡•ç‡§ü‡§æ‡§ö‡§æ‡§∞ ‡§µ‡§ø‡§∞‡•Å‡§¶‡•ç‡§ß ‡§∂‡•Ç‡§®‡•ç‡§Ø ‡§∏‡§π‡§®‡§∂‡•Ä‡§≤‡§§‡§æ", "titleEn": "End Corruption", "descEn": "Transparent governance, clean politics and strict action against corruption.", "icon": "üö´" }
    ]
}'::jsonb),

('about', '{
    "titleNe": "‡§π‡§æ‡§Æ‡•ç‡§∞‡•ã ‡§¨‡§æ‡§∞‡•á‡§Æ‡§æ",
    "titleEn": "About Us",
    "descriptionNe": "‡§™‡•ç‡§∞‡§ó‡§§‡§ø‡§∂‡•Ä‡§≤ ‡§≤‡•ã‡§ï‡§§‡§æ‡§®‡•ç‡§§‡•ç‡§∞‡§ø‡§ï ‡§™‡§æ‡§∞‡•ç‡§ü‡•Ä ‡§®‡•á‡§™‡§æ‡§≤‡§ï‡•ã ‡§∞‡§æ‡§ú‡§®‡•Ä‡§§‡§ø‡§ï ‡§™‡§∞‡§ø‡§¶‡•É‡§∂‡•ç‡§Ø‡§Æ‡§æ ‡§è‡§ï ‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï ‡§∂‡§ï‡•ç‡§§‡§ø‡§ï‡•ã ‡§∞‡•Ç‡§™‡§Æ‡§æ ‡§â‡§¶‡§æ‡§è‡§ï‡•ã ‡§õ‡•§ ‡§π‡§æ‡§Æ‡•Ä ‡§™‡§∞‡§Æ‡•ç‡§™‡§∞‡§æ‡§ó‡§§ ‡§∞‡§æ‡§ú‡§®‡•Ä‡§§‡§ø‡§ï‡•ã ‡§∏‡•Ä‡§Æ‡§æ‡§≤‡§æ‡§à ‡§§‡•ã‡§°‡•ç‡§¶‡•à ‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§®, ‡§™‡•ç‡§∞‡§µ‡§ø‡§ß‡§ø ‡§∞ ‡§Æ‡§æ‡§®‡§µ‡•Ä‡§Ø ‡§Æ‡•Ç‡§≤‡•ç‡§Ø‡§Æ‡§æ‡§®‡•ç‡§Ø‡§§‡§æ‡§Æ‡§æ ‡§Ü‡§ß‡§æ‡§∞‡§ø‡§§ ‡§®‡§Ø‡§æ‡§Å ‡§∞‡§æ‡§ú‡§®‡•Ä‡§§‡§ø‡§ï ‡§∏‡§Ç‡§∏‡•ç‡§ï‡•É‡§§‡§ø‡§ï‡•ã ‡§µ‡§ø‡§ï‡§æ‡§∏ ‡§ó‡§∞‡•ç‡§® ‡§ö‡§æ‡§π‡§®‡•ç‡§õ‡•å‡§Ç‡•§",
    "descriptionEn": "The Pragatishil Loktantrik Party (PDP) has emerged as an alternative force in Nepal''s political landscape. Breaking the boundaries of traditional politics, we aim to develop a new political culture based on science, technology, and human values."
}'::jsonb)
ON CONFLICT (key) DO NOTHING;

-- Seed News
INSERT INTO public.news_items (title, source, date, type, link, image_url)
VALUES
('‡§µ‡•à‡§ö‡§æ‡§∞‡§ø‡§ï ‡§ñ‡§°‡•á‡§∞‡•Ä‡§ï‡•ã ‡§ï‡§æ‡§≤‡§ñ‡§£‡•ç‡§° (A Period of Ideological Drought)', 'OnlineKhabar', '2024-08-25', 'Article', 'https://www.onlinekhabar.com/2025/08/1743950/a-period-of-ideological-drought', 'https://www.onlinekhabar.com/wp-content/uploads/2025/08/Baicharik-Khareri-1024x683.jpg'),
('Pragatishil Party Manifesto Launch', 'Kantipur', '2024-06-15', 'Article', 'https://ekantipur.com', 'https://picsum.photos/800/600?random=10'),
('Chairman Interview: The Way Forward', 'The Kathmandu Post', '2024-07-01', 'Interview', 'https://kathmandupost.com', 'https://picsum.photos/800/600?random=11');

-- Seed Videos
INSERT INTO public.media_gallery (type, url, caption)
VALUES
('video', 'https://www.youtube.com/embed/XusiP06Z_lg', 'Pragatishil Party Video 1'),
('video', 'https://www.youtube.com/embed/2-SkP3SIrKk', 'Pragatishil Party Video 2'),
('video', 'https://www.youtube.com/embed/TUMNWhBYfxs', 'Pragatishil Party Video 3');

-- ... (Existing Seed insertions)

-- 9. Storage Buckets & Policies
-- Note: 'storage' schema usually exists in Supabase.
-- Attempt to create 'media' bucket if not exists (requires permissions or manual creation)
INSERT INTO storage.buckets (id, name, public)
VALUES ('media', 'media', true)
ON CONFLICT (id) DO NOTHING;

-- Policy: Allow Public Read for 'media' bucket
CREATE POLICY "Public Access" ON storage.objects FOR SELECT USING (bucket_id = 'media');

-- Policy: Allow Authenticated Users (Admins) to Upload
CREATE POLICY "Auth Users Upload" ON storage.objects FOR INSERT WITH CHECK (
    bucket_id = 'media' AND auth.role() = 'authenticated'
);

-- Policy: Allow Authenticated Users (Admins) to Delete
CREATE POLICY "Auth Users Delete" ON storage.objects FOR DELETE USING (
    bucket_id = 'media' AND auth.role() = 'authenticated'
);
